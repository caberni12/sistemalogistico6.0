<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Log√≠stico Integrado</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
 --bg:#f1f5f9;
 --card:#ffffff;
 --hover:#f8fafc;
 --text:#0f172a;
 --muted:#64748b;
 --accent:#14b8a6;
 --border:#e2e8f0;
 --danger:#ef4444;
}

*{ box-sizing:border-box; font-family:system-ui,Arial,sans-serif; }

body{
 margin:0;
 background:var(--bg);
 color:var(--text);
 min-height:100vh;
 display:flex;
 flex-direction:column;
}

/* HEADER */
header{
 display:flex;
 align-items:center;
 justify-content:space-between;
 padding:18px 22px;
 background:#ffffff;
 border-bottom:1px solid var(--border);
 box-shadow:0 4px 12px rgba(0,0,0,.04);
 flex-wrap:wrap;
 gap:12px;
}

header h1{
 margin:0;
 font-size:20px;
 font-weight:700;
}

header .right{
 display:flex;
 gap:14px;
 align-items:center;
 flex-wrap:wrap;
}

header .user{
 font-size:13px;
 color:var(--muted);
 line-height:1.4;
}

header button{
 background:var(--danger);
 color:#fff;
 border:none;
 padding:8px 14px;
 border-radius:8px;
 cursor:pointer;
 font-weight:600;
}

/* GRID */
.grid{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
 gap:20px;
 padding:28px;
 max-width:1200px;
 margin:auto;
 width:100%;
}

/* CARD */
.card{
 background:var(--card);
 border-radius:18px;
 padding:26px;
 text-align:center;
 cursor:pointer;
 transition:.25s ease;
 border:1px solid var(--border);
 box-shadow:0 6px 18px rgba(0,0,0,.06);
}

.card:hover{
 background:var(--hover);
 transform:translateY(-4px);
 box-shadow:0 10px 28px rgba(0,0,0,.08);
}

.card-icon{ font-size:38px; margin-bottom:12px; }
.card h3{ margin:8px 0 4px; font-size:16px; font-weight:600; }
.card p{ font-size:13px; color:var(--muted); }

/* VIEWER */
.viewer{
 display:none;
 flex-direction:column;
 height:100vh;
 background:#ffffff;
}

.viewer-header{
 background:#ffffff;
 border-bottom:1px solid var(--border);
 padding:12px 16px;
 display:flex;
 align-items:center;
 justify-content:space-between;
 box-shadow:0 4px 12px rgba(0,0,0,.04);
}

.viewer-header span{ font-weight:600; }

.viewer-header button{
 background:var(--accent);
 border:none;
 padding:8px 14px;
 border-radius:8px;
 cursor:pointer;
 color:#fff;
 font-weight:600;
}

.viewer iframe{
 flex:1;
 border:none;
 width:100%;
}

/* MOBILE */
@media (max-width:768px){
  header{
    flex-direction:column;
    align-items:flex-start;
  }
  header h1{ font-size:18px; }
  header .right{
    width:100%;
    flex-direction:column;
    align-items:flex-start;
  }
  header button{
    width:100%;
    padding:14px;
    border-radius:12px;
  }
}
</style>
</head>

<body>

<header>
  <h1>üöÄ Sistema de Gesti√≥n Log√≠stica AS</h1>
  <div class="right">
    <div id="usuario" class="user"></div>
    <div id="conexionInfo" class="user"></div>

    <button id="btnRecargar" onclick="recargarPanel()" style="background:#3b82f6;">
      ‚ü≥ Recargar
    </button>

    <button onclick="cerrarSesion()">‚èª Cerrar Sesi√≥n</button>
  </div>
</header>

<!-- PANEL -->
<div id="panel" class="grid"></div>

<!-- VISOR -->
<div id="viewer" class="viewer">
  <div class="viewer-header">
    <span id="viewerTitle"></span>
    <button onclick="volver()">‚¨Ö Volver</button>
  </div>
  <iframe id="frame"></iframe>
</div>

<!-- ===================== JS ===================== -->

<script src="auth.js"></script>

<script>
/* ========= CONFIG ========= */
const API =
"https://script.google.com/macros/s/AKfycbwb_QOTIe9u1-LDSP1psBGeGkJ8gtC-n-e9H7E-rhf0gd2jU29sw-xHhXXp65OwQB_U/exec";

let USER_IP = "cargando...";

/* ========= INIT ========= */
document.addEventListener("DOMContentLoaded", async () => {

  const user = await validarSesionGlobal();
  if(!user) return;

  document.getElementById("usuario").innerHTML =
    `üë§ ${user.nombre} ¬∑ ${user.rol}`;

  cargarModulos(user);
  obtenerIP();
  iniciarReloj();
});

/* ========= MODULOS ========= */
async function cargarModulos(user){

  const r = await fetch(`${API}?action=listarModulos`);
  const res = await r.json();

  const panel = document.getElementById("panel");
  panel.innerHTML = "";

  if(!res.data) return;

  res.data.forEach(m=>{
    const [id,nombre,archivo,icono,permiso,activo] = m;

    if(activo !== "SI") return;
    if(user.rol !== "ADMIN" && !user.permisos.includes(permiso)) return;

    panel.innerHTML += `
      <div class="card" onclick="abrirModulo('${archivo}','${nombre}')">
        <div class="card-icon">${icono || "üì¶"}</div>
        <h3>${nombre}</h3>
        <p>M√≥dulo del sistema</p>
      </div>
    `;
  });
}

/* ========= VISOR ========= */
function abrirModulo(url,titulo){
  panel.style.display="none";
  viewer.style.display="flex";
  frame.src=url;
  viewerTitle.textContent=titulo;
}

function volver(){
  viewer.style.display="none";
  panel.style.display="grid";
  frame.src="";
}

/* ========= RECARGAR ========= */
async function recargarPanel(){
  const user = await validarSesionGlobal();
  if(!user) return;
  volver();
  cargarModulos(user);
}

/* ========= LOGOUT ========= */
function cerrarSesion(){
  cerrarSesionGlobal();
}

/* ========= FECHA / HORA / IP ========= */
function iniciarReloj(){
  actualizarConexion();
  setInterval(actualizarConexion,1000);
}

function actualizarConexion(){
  const now = new Date();
  conexionInfo.innerHTML = `
    üìÖ ${now.toLocaleDateString("es-CL")}<br>
    ‚è∞ ${now.toLocaleTimeString("es-CL")}<br>
    üåê IP: ${USER_IP}
  `;
}

async function obtenerIP(){
  try{
    const r = await fetch("https://api.ipify.org?format=json");
    const d = await r.json();
    USER_IP = d.ip;
  }catch{
    USER_IP = "no disponible";
  }
}
</script>

<script src="segurity.js"></script>

</body>
</html>



