<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Log√≠stico Integrado</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
 --bg:#f1f5f9;
 --card:#ffffff;
 --hover:#f8fafc;
 --text:#0f172a;
 --muted:#64748b;
 --accent:#14b8a6;
 --border:#e2e8f0;
 --danger:#ef4444;
}

*{ box-sizing:border-box; font-family:system-ui,Arial,sans-serif; }

body{
 margin:0;
 background:var(--bg);
 color:var(--text);
 min-height:100vh;
 display:flex;
 flex-direction:column;
}

/* HEADER */
header{
 display:flex;
 align-items:center;
 justify-content:space-between;
 padding:18px 22px;
 background:#ffffff;
 border-bottom:1px solid var(--border);
 box-shadow:0 4px 12px rgba(0,0,0,.04);
}

header h1{
 margin:0;
 font-size:20px;
 font-weight:700;
}

header .right{
 display:flex;
 gap:10px;
 align-items:center;
}

header .user{
 font-size:13px;
 color:var(--muted);
}

header button{
 background:var(--danger);
 color:#fff;
 border:none;
 padding:8px 14px;
 border-radius:8px;
 cursor:pointer;
 font-weight:600;
}

/* GRID */
.grid{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
 gap:20px;
 padding:28px;
 max-width:1200px;
 margin:auto;
 width:100%;
}

/* CARD */
.card{
 background:var(--card);
 border-radius:18px;
 padding:26px;
 text-align:center;
 cursor:pointer;
 transition:.25s ease;
 border:1px solid var(--border);
 box-shadow:0 6px 18px rgba(0,0,0,.06);
}

.card:hover{
 background:var(--hover);
 transform:translateY(-4px);
 box-shadow:0 10px 28px rgba(0,0,0,.08);
}

.card-icon{ font-size:38px; margin-bottom:12px; }
.card h3{ margin:8px 0 4px; font-size:16px; font-weight:600; }
.card p{ font-size:13px; color:var(--muted); }

/* VIEWER */
.viewer{
 display:none;
 flex-direction:column;
 height:100vh;
 background:#ffffff;
}

.viewer-header{
 background:#ffffff;
 border-bottom:1px solid var(--border);
 padding:12px 16px;
 display:flex;
 align-items:center;
 justify-content:space-between;
 box-shadow:0 4px 12px rgba(0,0,0,.04);
}

.viewer-header span{ font-weight:600; }

.viewer-header button{
 background:var(--accent);
 border:none;
 padding:8px 14px;
 border-radius:8px;
 cursor:pointer;
 color:#fff;
 font-weight:600;
}

.viewer iframe{
 flex:1;
 border:none;
 width:100%;
}

/* ================= HEADER M√ìVIL ================= */
@media (max-width:768px){

  header{
    flex-direction:column;
    align-items:flex-start;
    gap:12px;
    padding:16px;
  }

  header h1{
    font-size:18px;
    line-height:1.2;
  }

  header .right{
    width:100%;
    flex-direction:column;
    align-items:stretch;
    gap:10px;
  }

  header .user{
    font-size:14px;
    padding:6px 0;
  }

  header button{
    width:100%;
    padding:14px;
    font-size:15px;
    border-radius:12px;
  }
}

</style>
</head>

<body>

<header>
  <h1>üöÄ Sistema de Gestion Logistica AS</h1>
  <div class="right">
    <div id="usuario" class="user"></div>
    
    <button id="btnRecargar" onclick="recargarPanel()" style="background:#3b82f6;">
      <span id="recargarText">‚ü≥ Recargar</span>
      <span id="recargarLoader" style="display:none;">‚è≥</span>
    </button>
    
    <button onclick="cerrarSesion()">‚èª Cerrar Sesi√≥n</button>
  </div>
</header>

<!-- PANEL DIN√ÅMICO -->
<div id="panel" class="grid"></div>

<!-- VISOR -->
<div id="viewer" class="viewer">
  <div class="viewer-header">
    <span id="viewerTitle"></span>
    <button onclick="volver()">‚¨Ö Volver</button>
  </div>
  <iframe id="frame"></iframe>
</div>


<script>
/* =====================================================
   MAIN.JS ‚Äî PANEL PRINCIPAL (FINAL)
===================================================== */

/* ========= CONFIG ========= */
const API =
  "https://script.google.com/macros/s/AKfycbzMad3A7vIO3nn-BXaNysrOcoFQtsWEdYe4kdALM52IY0nKoVaZ5zClEpqOk74ewW2b/exec";

/* =====================================================
   INIT
===================================================== */
document.addEventListener("DOMContentLoaded", async () => {

  // üîê validar sesi√≥n UNA sola vez (auth.js)
  const user = await validarSesionGlobal();
  if (!user) return;

  // Mostrar usuario
  const userBox = document.getElementById("usuario");
  if (userBox) {
    userBox.innerHTML = `üë§ ${user.nombre} ¬∑ ${user.rol}`;
  }

  // Cargar m√≥dulos
  cargarModulos(user);
});

/* =====================================================
   CARGAR M√ìDULOS
===================================================== */
async function cargarModulos(user){

  try{
    const r = await fetch(`${API}?action=listarModulos`);
    const res = await r.json();

    const panel = document.getElementById("panel");
    panel.innerHTML = "";

    if (!res.data || !Array.isArray(res.data)) {
      panel.innerHTML = "<p>No hay m√≥dulos disponibles</p>";
      return;
    }

    res.data.forEach(m => {
      const [id, nombre, archivo, icono, permiso, activo] = m;

      if (activo !== "SI") return;

      // ADMIN ve todo
      if (user.rol !== "ADMIN") {
        if (!user.permisos || !user.permisos.includes(permiso)) return;
      }

      panel.innerHTML += `
        <div class="card" onclick="abrirModulo('${archivo}','${nombre}')">
          <div class="card-icon">${icono || "üì¶"}</div>
          <h3>${nombre}</h3>
          <p>M√≥dulo del sistema</p>
        </div>
      `;
    });

  }catch(err){
    console.error("Error cargando m√≥dulos", err);
    alert("No se pudieron cargar los m√≥dulos");
  }
}

/* =====================================================
   VISOR DE M√ìDULOS
===================================================== */
function abrirModulo(url, titulo){
  const panel = document.getElementById("panel");
  const viewer = document.getElementById("viewer");
  const frame = document.getElementById("frame");
  const title = document.getElementById("viewerTitle");

  panel.style.display = "none";
  viewer.style.display = "flex";
  frame.src = url;
  title.textContent = titulo;
}

function volver(){
  const panel = document.getElementById("panel");
  const viewer = document.getElementById("viewer");
  const frame = document.getElementById("frame");

  viewer.style.display = "none";
  panel.style.display = "grid";
  frame.src = "";
}

/* =====================================================
   RECARGAR PANEL
===================================================== */
async function recargarPanel(){

  const btn = document.getElementById("btnRecargar");
  const text = document.getElementById("recargarText");
  const loader = document.getElementById("recargarLoader");

  if (btn) btn.disabled = true;
  if (text) text.style.display = "none";
  if (loader) loader.style.display = "inline";

  try{
    const user = await validarSesionGlobal();
    if (!user) return;

    // Reset visor
    volver();

    // Actualizar usuario
    document.getElementById("usuario").innerHTML =
      `üë§ ${user.nombre} ¬∑ ${user.rol}`;

    // Recargar m√≥dulos
    cargarModulos(user);

  }catch(err){
    console.error(err);
    alert("No se pudo recargar el panel");
  }finally{
    if (btn) btn.disabled = false;
    if (text) text.style.display = "inline";
    if (loader) loader.style.display = "none";
  }
}

/* =====================================================
   LOGOUT
===================================================== */
function cerrarSesion(){
  cerrarSesionGlobal(); // viene desde auth.js
}

</script>

  
<script src="app_pro.js"></script>
<script src="segurity.js"></script>
<script src="auth.js"></script>

</body>
</html>




